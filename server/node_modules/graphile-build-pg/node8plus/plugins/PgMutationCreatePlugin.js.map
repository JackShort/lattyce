{"version":3,"sources":["../../src/plugins/PgMutationCreatePlugin.js"],"names":["debug","PgMutationCreatePlugin","builder","pgDisableDefaultMutations","hook","fields","build","context","extend","newWithHooks","parseResolveInfo","pgIntrospectionResultsByKind","pgGetGqlTypeByTypeIdAndModifier","pgGetGqlInputTypeByTypeIdAndModifier","pgSql","sql","gql2pg","graphql","GraphQLObjectType","GraphQLInputObjectType","GraphQLNonNull","GraphQLString","pgColumnFilter","inflection","pgQueryFromResolveData","queryFromResolveData","pgOmit","omit","pgViaTemporaryTable","viaTemporaryTable","scope","isRootMutation","fieldWithHooks","class","filter","table","namespace","isSelectable","isInsertable","reduce","memo","Table","type","id","name","TableInput","tableTypeName","tableType","InputType","createInputType","description","clientMutationId","tableFieldName","isPgCreateInputType","pgInflection","PayloadType","createPayloadType","recurseDataGeneratorsForField","tableName","resolve","data","isMutationPayload","isPgCreatePayloadType","pgIntrospection","fieldName","createField","getDataFromParsedResolveInfoFragment","args","input","pgClient","resolveInfo","parsedResolveInfoFragment","resolveData","insertedRowAlias","identifier","Symbol","query","sqlColumns","sqlValues","inputData","attribute","attr","classId","forEach","column","val","Object","prototype","hasOwnProperty","call","push","typeModifier","mutationQuery","length","fragment","join","row","rows","e","pgFieldIntrospection","isPgCreateMutationField"],"mappings":";;;;;;AAEA;;;;;;AAEA,MAAMA,QAAQ,qBAAa,mBAAb,CAAd;;kBAEgB,SAASC,sBAAT,CACdC,OADc,EAEd,EAAEC,yBAAF,EAFc,EAGd;AACA,MAAIA,yBAAJ,EAA+B;AAC7B;AACD;AACDD,UAAQE,IAAR,CAAa,0BAAb,EAAyC,CAACC,MAAD,EAASC,KAAT,EAAgBC,OAAhB,KAA4B;AACnE,UAAM;AACJC,YADI;AAEJC,kBAFI;AAGJC,sBAHI;AAIJC,kCAJI;AAKJC,qCALI;AAMJC,0CANI;AAOJC,aAAOC,GAPH;AAQJC,YARI;AASJC,eAAS;AACPC,yBADO;AAEPC,8BAFO;AAGPC,sBAHO;AAIPC;AAJO,OATL;AAeJC,oBAfI;AAgBJC,gBAhBI;AAiBJC,8BAAwBC,oBAjBpB;AAkBJC,cAAQC,IAlBJ;AAmBJC,2BAAqBC;AAnBjB,QAoBFvB,KApBJ;AAqBA,UAAM;AACJwB,aAAO,EAAEC,cAAF,EADH;AAEJC;AAFI,QAGFzB,OAHJ;AAIA,QAAI,CAACwB,cAAL,EAAqB;AACnB,aAAO1B,MAAP;AACD;;AAED,WAAOG,OACLH,MADK,EAELM,6BAA6BsB,KAA7B,CACGC,MADH,CACUC,SAAS,CAAC,CAACA,MAAMC,SAD3B,EAEGF,MAFH,CAEUC,SAASA,MAAME,YAFzB,EAGGH,MAHH,CAGUC,SAASA,MAAMG,YAAN,IAAsB,CAACX,KAAKQ,KAAL,EAAY,QAAZ,CAH1C,EAIGI,MAJH,CAIU,CAACC,IAAD,EAAOL,KAAP,KAAiB;AACvB,YAAMM,QAAQ7B,gCAAgCuB,MAAMO,IAAN,CAAWC,EAA3C,EAA+C,IAA/C,CAAd;AACA,UAAI,CAACF,KAAL,EAAY;AACVzC,cACG,sCAAqCmC,MAAMC,SAAN,CAAgBQ,IAAK,IACzDT,MAAMS,IACP,sDAHH;AAKA,eAAOJ,IAAP;AACD;AACD,YAAMK,aAAahC,qCACjBsB,MAAMO,IAAN,CAAWC,EADM,EAEjB,IAFiB,CAAnB;AAIA,UAAI,CAACE,UAAL,EAAiB;AACf7C,cACG,sCAAqCmC,MAAMC,SAAN,CAAgBQ,IAAK,IACzDT,MAAMS,IACP,wDAHH;AAKD;AACD,YAAME,gBAAgBvB,WAAWwB,SAAX,CAAqBZ,KAArB,CAAtB;AACA,YAAMa,YAAYvC,aAChBU,sBADgB,EAEhB;AACEyB,cAAMrB,WAAW0B,eAAX,CAA2Bd,KAA3B,CADR;AAEEe,qBAAc,8BAA6BJ,aAAc,cAF3D;AAGEzC,gBAAQ;AACN8C,4BAAkB;AAChBD,yBACE,6IAFc;AAGhBR,kBAAMrB;AAHU,WADZ;AAMN,cAAIwB,aACA;AACE,aAACtB,WAAW6B,cAAX,CAA0BjB,KAA1B,CAAD,GAAoC;AAClCe,2BAAc,SAAQJ,aAAc,oCADF;AAElCJ,oBAAM,IAAItB,cAAJ,CAAmByB,UAAnB;AAF4B;AADtC,WADA,GAOA,IAPJ;AANM;AAHV,OAFgB,EAqBhB;AACEQ,6BAAqB,IADvB;AAEEC,sBAAcnB;AAFhB,OArBgB,CAAlB;AA0BA,YAAMoB,cAAc9C,aAClBS,iBADkB,EAElB;AACE0B,cAAMrB,WAAWiC,iBAAX,CAA6BrB,KAA7B,CADR;AAEEe,qBAAc,8BAA6BJ,aAAc,cAF3D;AAGEzC,gBAAQ,CAAC,EAAEoD,6BAAF,EAAD,KAAuC;AAC7C,gBAAMC,YAAYnC,WAAW6B,cAAX,CAA0BjB,KAA1B,CAAlB;AACAsB,wCAA8BC,SAA9B;AACA,iBAAO;AACLP,8BAAkB;AAChBD,2BACE,8IAFc;AAGhBR,oBAAMrB;AAHU,aADb;AAML,aAACqC,SAAD,GAAa;AACXR,2BAAc,SAAQJ,aAAc,uCADzB;AAEXJ,oBAAMD,KAFK;AAGXkB,sBAAQC,IAAR,EAAc;AACZ,uBAAOA,KAAKA,IAAZ;AACD;AALU;AANR,WAAP;AAcD;AApBH,OAFkB,EAwBlB;AACEC,2BAAmB,IADrB;AAEEC,+BAAuB,IAFzB;AAGEC,yBAAiB5B;AAHnB,OAxBkB,CAApB;AA8BA,YAAM6B,YAAYzC,WAAW0C,WAAX,CAAuB9B,KAAvB,CAAlB;AACAK,WAAKwB,SAAL,IAAkBhC,eAChBgC,SADgB,EAEhBzD,WAAW;AACT,cAAM,EAAE2D,oCAAF,KAA2C3D,OAAjD;AACA,eAAO;AACL2C,uBAAc,sBAAqBJ,aAAc,KAD5C;AAELJ,gBAAMa,WAFD;AAGLY,gBAAM;AACJC,mBAAO;AACL1B,oBAAM,IAAItB,cAAJ,CAAmB4B,SAAnB;AADD;AADH,WAHD;AAQL,gBAAMW,OAAN,CAAcC,IAAd,EAAoB,EAAEQ,KAAF,EAApB,EAA+B,EAAEC,QAAF,EAA/B,EAA6CC,WAA7C,EAA0D;AACxD,kBAAMC,4BAA4B7D,iBAChC4D,WADgC,CAAlC;AAGA,kBAAME,cAAcN,qCAClBK,yBADkB,EAElBhB,WAFkB,CAApB;AAIA,kBAAMkB,mBAAmB1D,IAAI2D,UAAJ,CAAeC,QAAf,CAAzB;AACA,kBAAMC,QAAQnD,qBACZgD,gBADY,EAEZA,gBAFY,EAGZD,WAHY,EAIZ,EAJY,CAAd;AAMA,kBAAMK,aAAa,EAAnB;AACA,kBAAMC,YAAY,EAAlB;AACA,kBAAMC,YAAYX,MAAM7C,WAAW6B,cAAX,CAA0BjB,KAA1B,CAAN,CAAlB;AACAxB,yCAA6BqE,SAA7B,CACG9C,MADH,CACU+C,QAAQA,KAAKC,OAAL,KAAiB/C,MAAMQ,EADzC,EAEGT,MAFH,CAEU+C,QAAQ3D,eAAe2D,IAAf,EAAqB3E,KAArB,EAA4BC,OAA5B,CAFlB,EAGG2B,MAHH,CAGU+C,QAAQ,CAACtD,KAAKsD,IAAL,EAAW,QAAX,CAHnB,EAIGE,OAJH,CAIWF,QAAQ;AACf,oBAAMjB,YAAYzC,WAAW6D,MAAX,CAAkBH,IAAlB,CAAlB;AACA,oBAAMI,MAAMN,UAAUf,SAAV,CAAZ;AACA,kBACEsB,OAAOC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CACEV,SADF,EAEEf,SAFF,CADF,EAKE;AACAa,2BAAWa,IAAX,CAAgB3E,IAAI2D,UAAJ,CAAeO,KAAKrC,IAApB,CAAhB;AACAkC,0BAAUY,IAAV,CACE1E,OAAOqE,GAAP,EAAYJ,KAAKvC,IAAjB,EAAuBuC,KAAKU,YAA5B,CADF;AAGD;AACF,aAlBH;;AAoBA,kBAAMC,gBAAgB7E,IAAI6D,KAAM;kCAChB7D,IAAI2D,UAAJ,CACZvC,MAAMC,SAAN,CAAgBQ,IADJ,EAEZT,MAAMS,IAFM,CAGZ,IACFiC,WAAWgB,MAAX,GACI9E,IAAI+E,QAAS;0BACX/E,IAAIgF,IAAJ,CAASlB,UAAT,EAAqB,IAArB,CAA2B;iCACpB9D,IAAIgF,IAAJ,CAASjB,SAAT,EAAoB,IAApB,CAA0B,GAHvC,GAII/D,IAAI+E,QAAS,gBAClB,cAVD;;AAYA,gBAAIE,GAAJ;AACA,gBAAI;AACF,oBAAM3B,SAASO,KAAT,CAAe,4BAAf,CAAN;AACA,oBAAMqB,OAAO,MAAMpE,kBACjBwC,QADiB,EAEjBtD,IAAI2D,UAAJ,CAAevC,MAAMC,SAAN,CAAgBQ,IAA/B,EAAqCT,MAAMS,IAA3C,CAFiB,EAGjBgD,aAHiB,EAIjBnB,gBAJiB,EAKjBG,KALiB,CAAnB;AAOAoB,oBAAMC,KAAK,CAAL,CAAN;AACA,oBAAM5B,SAASO,KAAT,CAAe,oCAAf,CAAN;AACD,aAXD,CAWE,OAAOsB,CAAP,EAAU;AACV,oBAAM7B,SAASO,KAAT,CACJ,wCADI,CAAN;AAGA,oBAAMsB,CAAN;AACD;AACD,mBAAO;AACL/C,gCAAkBiB,MAAMjB,gBADnB;AAELS,oBAAMoC;AAFD,aAAP;AAID;AAhFI,SAAP;AAkFD,OAtFe,EAuFhB;AACEG,8BAAsBhE,KADxB;AAEEiE,iCAAyB;AAF3B,OAvFgB,CAAlB;AA4FA,aAAO5D,IAAP;AACD,KAhLH,EAgLK,EAhLL,CAFK,EAmLJ,mDAnLI,CAAP;AAqLD,GAnND;AAoND,C","file":"PgMutationCreatePlugin.js","sourcesContent":["// @flow\nimport type { Plugin } from \"graphile-build\";\nimport debugFactory from \"debug\";\n\nconst debug = debugFactory(\"graphile-build-pg\");\n\nexport default (function PgMutationCreatePlugin(\n  builder,\n  { pgDisableDefaultMutations }\n) {\n  if (pgDisableDefaultMutations) {\n    return;\n  }\n  builder.hook(\"GraphQLObjectType:fields\", (fields, build, context) => {\n    const {\n      extend,\n      newWithHooks,\n      parseResolveInfo,\n      pgIntrospectionResultsByKind,\n      pgGetGqlTypeByTypeIdAndModifier,\n      pgGetGqlInputTypeByTypeIdAndModifier,\n      pgSql: sql,\n      gql2pg,\n      graphql: {\n        GraphQLObjectType,\n        GraphQLInputObjectType,\n        GraphQLNonNull,\n        GraphQLString,\n      },\n      pgColumnFilter,\n      inflection,\n      pgQueryFromResolveData: queryFromResolveData,\n      pgOmit: omit,\n      pgViaTemporaryTable: viaTemporaryTable,\n    } = build;\n    const {\n      scope: { isRootMutation },\n      fieldWithHooks,\n    } = context;\n    if (!isRootMutation) {\n      return fields;\n    }\n\n    return extend(\n      fields,\n      pgIntrospectionResultsByKind.class\n        .filter(table => !!table.namespace)\n        .filter(table => table.isSelectable)\n        .filter(table => table.isInsertable && !omit(table, \"create\"))\n        .reduce((memo, table) => {\n          const Table = pgGetGqlTypeByTypeIdAndModifier(table.type.id, null);\n          if (!Table) {\n            debug(\n              `There was no table type for table '${table.namespace.name}.${\n                table.name\n              }', so we're not generating a create mutation for it.`\n            );\n            return memo;\n          }\n          const TableInput = pgGetGqlInputTypeByTypeIdAndModifier(\n            table.type.id,\n            null\n          );\n          if (!TableInput) {\n            debug(\n              `There was no input type for table '${table.namespace.name}.${\n                table.name\n              }', so we're going to omit it from the create mutation.`\n            );\n          }\n          const tableTypeName = inflection.tableType(table);\n          const InputType = newWithHooks(\n            GraphQLInputObjectType,\n            {\n              name: inflection.createInputType(table),\n              description: `All input for the create \\`${tableTypeName}\\` mutation.`,\n              fields: {\n                clientMutationId: {\n                  description:\n                    \"An arbitrary string value with no semantic meaning. Will be included in the payload verbatim. May be used to track mutations by the client.\",\n                  type: GraphQLString,\n                },\n                ...(TableInput\n                  ? {\n                      [inflection.tableFieldName(table)]: {\n                        description: `The \\`${tableTypeName}\\` to be created by this mutation.`,\n                        type: new GraphQLNonNull(TableInput),\n                      },\n                    }\n                  : null),\n              },\n            },\n            {\n              isPgCreateInputType: true,\n              pgInflection: table,\n            }\n          );\n          const PayloadType = newWithHooks(\n            GraphQLObjectType,\n            {\n              name: inflection.createPayloadType(table),\n              description: `The output of our create \\`${tableTypeName}\\` mutation.`,\n              fields: ({ recurseDataGeneratorsForField }) => {\n                const tableName = inflection.tableFieldName(table);\n                recurseDataGeneratorsForField(tableName);\n                return {\n                  clientMutationId: {\n                    description:\n                      \"The exact same `clientMutationId` that was provided in the mutation input, unchanged and unused. May be used by a client to track mutations.\",\n                    type: GraphQLString,\n                  },\n                  [tableName]: {\n                    description: `The \\`${tableTypeName}\\` that was created by this mutation.`,\n                    type: Table,\n                    resolve(data) {\n                      return data.data;\n                    },\n                  },\n                };\n              },\n            },\n            {\n              isMutationPayload: true,\n              isPgCreatePayloadType: true,\n              pgIntrospection: table,\n            }\n          );\n          const fieldName = inflection.createField(table);\n          memo[fieldName] = fieldWithHooks(\n            fieldName,\n            context => {\n              const { getDataFromParsedResolveInfoFragment } = context;\n              return {\n                description: `Creates a single \\`${tableTypeName}\\`.`,\n                type: PayloadType,\n                args: {\n                  input: {\n                    type: new GraphQLNonNull(InputType),\n                  },\n                },\n                async resolve(data, { input }, { pgClient }, resolveInfo) {\n                  const parsedResolveInfoFragment = parseResolveInfo(\n                    resolveInfo\n                  );\n                  const resolveData = getDataFromParsedResolveInfoFragment(\n                    parsedResolveInfoFragment,\n                    PayloadType\n                  );\n                  const insertedRowAlias = sql.identifier(Symbol());\n                  const query = queryFromResolveData(\n                    insertedRowAlias,\n                    insertedRowAlias,\n                    resolveData,\n                    {}\n                  );\n                  const sqlColumns = [];\n                  const sqlValues = [];\n                  const inputData = input[inflection.tableFieldName(table)];\n                  pgIntrospectionResultsByKind.attribute\n                    .filter(attr => attr.classId === table.id)\n                    .filter(attr => pgColumnFilter(attr, build, context))\n                    .filter(attr => !omit(attr, \"create\"))\n                    .forEach(attr => {\n                      const fieldName = inflection.column(attr);\n                      const val = inputData[fieldName];\n                      if (\n                        Object.prototype.hasOwnProperty.call(\n                          inputData,\n                          fieldName\n                        )\n                      ) {\n                        sqlColumns.push(sql.identifier(attr.name));\n                        sqlValues.push(\n                          gql2pg(val, attr.type, attr.typeModifier)\n                        );\n                      }\n                    });\n\n                  const mutationQuery = sql.query`\n                    insert into ${sql.identifier(\n                      table.namespace.name,\n                      table.name\n                    )} ${\n                    sqlColumns.length\n                      ? sql.fragment`(\n                        ${sql.join(sqlColumns, \", \")}\n                      ) values(${sql.join(sqlValues, \", \")})`\n                      : sql.fragment`default values`\n                  } returning *`;\n\n                  let row;\n                  try {\n                    await pgClient.query(\"SAVEPOINT graphql_mutation\");\n                    const rows = await viaTemporaryTable(\n                      pgClient,\n                      sql.identifier(table.namespace.name, table.name),\n                      mutationQuery,\n                      insertedRowAlias,\n                      query\n                    );\n                    row = rows[0];\n                    await pgClient.query(\"RELEASE SAVEPOINT graphql_mutation\");\n                  } catch (e) {\n                    await pgClient.query(\n                      \"ROLLBACK TO SAVEPOINT graphql_mutation\"\n                    );\n                    throw e;\n                  }\n                  return {\n                    clientMutationId: input.clientMutationId,\n                    data: row,\n                  };\n                },\n              };\n            },\n            {\n              pgFieldIntrospection: table,\n              isPgCreateMutationField: true,\n            }\n          );\n          return memo;\n        }, {}),\n      `Adding default 'create' mutation to root mutation`\n    );\n  });\n}: Plugin);\n"]}